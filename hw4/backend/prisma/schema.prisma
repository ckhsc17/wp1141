// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 使用者模型
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  avatar    String?
  googleId  String?  @unique // 改為 optional，因為傳統註冊不需要
  password  String?  // 新增密碼欄位，OAuth 用戶不需要
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  treasures Treasure[]
  likes     Like[]
  comments  Comment[]
  favorites Favorite[]
  collects  Collect[]

  @@map("users")
}

// 寶藏模型
model Treasure {
  id               String      @id @default(cuid())
  userId           String
  title            String      @db.VarChar(100)
  content          String      @db.Text
  type             TreasureType
  latitude         Float       @db.DoublePrecision
  longitude        Float       @db.DoublePrecision
  address          String?     @db.VarChar(255)
  amount           String?     @db.VarChar(100) // 新增金額欄位
  isPublic         Boolean?    // 新增公開狀態欄位（用於生活碎片）
  isHidden         Boolean?    // 新增隱藏狀態欄位（用於寶藏）
  mediaUrl         String?     @db.VarChar(500)
  linkUrl          String?     @db.VarChar(500)
  isLiveLocation   Boolean     @default(false)
  locationRadius   Int         @default(20) // 公尺
  tags             String[]
  likesCount       Int         @default(0)
  commentsCount    Int         @default(0)
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  deletedAt        DateTime?   // 軟刪除時間戳記

  // Relations
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  likes     Like[]
  comments  Comment[]
  favorites Favorite[]
  collects  Collect[]

  // Indexes for performance
  @@index([latitude, longitude])
  @@index([type, createdAt])
  @@index([userId, createdAt])
  @@index([tags])
  @@index([deletedAt]) // 為軟刪除查詢優化
  @@map("treasures")
}

// 按讚模型
model Like {
  id         String   @id @default(cuid())
  userId     String
  treasureId String
  createdAt  DateTime @default(now())

  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  treasure Treasure @relation(fields: [treasureId], references: [id], onDelete: Cascade)

  // 複合唯一約束：一個使用者對一個寶藏只能按一次讚
  @@unique([userId, treasureId])
  @@index([treasureId])
  @@map("likes")
}

// 留言模型
model Comment {
  id         String   @id @default(cuid())
  userId     String
  treasureId String
  content    String   @db.VarChar(500)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  deletedAt  DateTime? // 軟刪除時間戳記

  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  treasure Treasure @relation(fields: [treasureId], references: [id], onDelete: Cascade)

  @@index([treasureId, createdAt])
  @@index([deletedAt]) // 為軟刪除查詢優化
  @@map("comments")
}

// 收藏模型
model Favorite {
  id         String   @id @default(cuid())
  userId     String
  treasureId String
  createdAt  DateTime @default(now())

  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  treasure Treasure @relation(fields: [treasureId], references: [id], onDelete: Cascade)

  // 複合唯一約束：一個使用者對一個寶藏只能收藏一次
  @@unique([userId, treasureId])
  @@index([userId, createdAt])
  @@map("favorites")
}

// 收集模型
model Collect {
  id         String   @id @default(cuid())
  userId     String
  treasureId String
  createdAt  DateTime @default(now())
  isLocked   Boolean  @default(false)

  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  treasure Treasure @relation(fields: [treasureId], references: [id], onDelete: Cascade)

  // 複合唯一約束：一個使用者對一個寶藏只能收集一次
  @@unique([userId, treasureId])
  @@index([userId, createdAt])
  @@map("collects")
}

// 寶藏類型枚舉
enum TreasureType {
  music
  audio
  text
  link
  live_moment

  @@map("treasure_type")
}
